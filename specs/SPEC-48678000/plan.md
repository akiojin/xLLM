# 実装計画: モデル自動解決機能

**機能ID**: `SPEC-48678000` | **日付**: 2025-12-06 | **仕様**: [spec.md](./spec.md)
**ステータス**: 計画中（2025-12-30更新: 仕様改定に伴い計画更新）

## 概要

モデルがローカルにない場合の自動解決フロー:

1. ローカルストレージを確認し、存在すればそのパスを使用
2. ローカルにない場合、`supported_models.json`の定義を参照し外部ソース（HF等）から取得
3. 外部ソース不可の場合、ロードバランサープロキシ経由で取得
4. `supported_models.json`に未定義のモデルはエラー

**注意**: 共有パス機能は廃止（Session 2025-12-30で確定）

## 技術コンテキスト

**言語/バージョン**: C++17, Rust 1.75+
**主要依存関係**: llama.cpp, httplib (C++), reqwest (Rust)
**ストレージ**: ファイルシステム (`~/.llmlb/models/`)
**テスト**: Google Test, cargo test
**対象プラットフォーム**: Windows/macOS
**プロジェクトタイプ**: web (node/, llmlb/)

## 憲章チェック

**シンプルさ**: ✅ 合格

- プロジェクト数: 2 (node, router)
- 明確なフォールバックフロー（ローカル → 外部ソース → プロキシ）
- `supported_models.json`でサポートモデルを一元管理

**テスト**: ✅ 合格

- TDD順序: Contract→Integration→E2E→Unit
- モックサーバーでAPI経由テスト

## モデル解決フロー

```text
推論リクエスト受信
    │
    ▼
ローカルキャッシュ確認 ─────────────────┐
    │ 存在する                          │ 存在しない
    ▼                                   ▼
モデルロード              supported_models.json確認
                                    │
                    ┌───────────────┴───────────────┐
                    │ 定義あり                       │ 定義なし
                    ▼                               ▼
            外部ソース（HF等）へアクセス          エラー返却
                    │                     「モデル未サポート」
        ┌───────────┴───────────────┐
        │ 成功                       │ 失敗
        ▼                           ▼
    ダウンロード＆保存       ロードバランサープロキシ経由取得
                                    │
                        ┌───────────┴───────────┐
                        │ 成功                   │ 失敗
                        ▼                       ▼
                    ダウンロード＆保存      エラー返却
```

## Phase 2: タスク計画アプローチ

**タスク生成戦略**:

1. 共有パス関連コード削除（廃止）
2. `supported_models.json`参照ロジック実装
3. 外部ソース（HF等）からのダウンロード実装
4. ロードバランサープロキシ経由ダウンロード実装
5. 重複ダウンロード防止ロジック実装
6. ダウンロード進捗通知実装
7. エラーハンドリング強化
8. 統合テスト

**順序戦略**:

- まず削除（共有パス関連）
- 次に新規実装（解決フロー）
- 最後に統合テスト

## 進捗トラッキング

**フェーズステータス**:

- [x] Phase 0: Research完了
- [x] Phase 1: Design完了
- [x] Phase 2: Task planning完了（2025-12-30更新）
- [ ] Phase 3: Tasks生成済み
- [ ] Phase 4: 実装完了
- [ ] Phase 5: 検証合格

**ゲートステータス**:

- [x] 初期憲章チェック: 合格
- [x] 設計後憲章チェック: 合格
- [x] すべての要明確化解決済み（Session 2025-12-30）
- [ ] 複雑さの逸脱を文書化済み

---

*憲章 v1.0.0 に基づく - `/memory/constitution.md` 参照*
