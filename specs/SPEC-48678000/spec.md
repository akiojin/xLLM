# 機能仕様書: モデル自動解決機能

**機能ID**: `SPEC-48678000`
**作成日**: 2025-12-06
**更新日**: 2026-01-25
**ステータス**: 改定中（自動認識への移行）
**入力**: ユーザー説明: "モデル自動解決機能: xLLMランタイム側でモデルが存在しない場合、HuggingFaceから直接取得し、config.jsonからアーキテクチャを自動検出する。"

## 用語

- 本仕様の「ノード」は、xLLMランタイム（推論サーバー）を指す。

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 外部ソースからのモデル自動取得 (優先度: P1)

ノードオペレーターとして、推論リクエストを受けた際にモデルがローカルにない場合、`supported_models.json`に定義済みのモデルを外部ソース（Hugging Face等）から自動的にダウンロードできるようにしたい。これにより、手動でのモデル配布なしにシステムを運用できる。

**この優先度の理由**: ノードの自律運用を可能にし、モデル配布の手間を大幅に削減する。

**独立テスト**: `supported_models.json`に定義されたモデルで推論リクエストを送信し、モデルが自動ダウンロードされて推論結果が返ることを確認できる。

**受け入れシナリオ**:

1. **前提** ノードのローカルにモデルがなく、`supported_models.json`にモデルが定義済み、**実行** 推論リクエストを送信、**結果** 外部ソースからモデルがダウンロードされ、推論結果が返る

2. **前提** モデルのダウンロード中、**実行** ダウンロード進捗を確認、**結果** 進捗状況が通知される
3. **前提** モデルのダウンロード中、**実行** ロードバランサーのダッシュボードを開く、**結果** ノードの同期状態（同期中/完了/失敗）と進捗が表示される

---

### ユーザーストーリー2 - 外部ソース直取得の必須化 (優先度: P2)

ノードオペレーターとして、ノードが外部ソース（Hugging Face等）から直接モデルをダウンロードできることを必須条件としたい。ロードバランサーはメタデータを提供するだけで、モデルバイナリは保持しない。

**この優先度の理由**: ロードバランサーのキャッシュ/変換に依存せず、ノードが自律的に取得・保持する運用を保証するため。

**独立テスト**: ロードバランサーがバイナリを保持していない状態でも、ノードが外部ソースから直接ダウンロードして推論できることを確認する。

---

### ユーザーストーリー3 - 未対応アーキテクチャのエラー通知 (優先度: P1)

ノードオペレーターとして、対応エンジンが存在しないアーキテクチャのモデルをリクエストされた場合、明確なエラーメッセージを受け取りたい。これにより、問題の原因を迅速に特定し、適切な対処を行える。

**この優先度の理由**: 運用時のトラブルシューティングに必須。ユーザーが問題を理解し対処するために必要。

**独立テスト**: 対応エンジンが存在しないアーキテクチャのモデルで推論リクエストを送信し、適切なエラーレスポンスが返ることを確認する。

**受け入れシナリオ**:

1. **前提** モデルのアーキテクチャに対応エンジンが存在しない、**実行** 推論リクエストを送信、**結果** アーキテクチャがサポートされていないことを示すエラーレスポンスが返る

---

### エッジケース

- ダウンロード中にノードが再起動した場合、次回起動時に再ダウンロードを試行する
- 複数のリクエストが同時に同じモデルを要求した場合、重複ダウンロードを防止する
- ダウンロード中のリクエストには適切な待機レスポンスを返す

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはモデル要求時、まずローカルストレージを確認し、存在すればそのパスを使用する必要がある
- **FR-002**: ~~システムはローカルにモデルがない場合、`supported_models.json`の定義を参照し、外部ソース（Hugging Face等）からダウンロードする必要がある~~ **改定**:
  システムはローカルにモデルがない場合、HuggingFace URLから直接ダウンロードする必要がある
- **FR-003**: システムは外部ソース（Hugging Face等）から**直接**モデルをダウンロードする必要がある
- **FR-004**: システムはダウンロードしたモデルをローカルに保存する必要がある
- **FR-005**: ~~システムは`supported_models.json`に未定義のモデルが要求された場合、エラーを返す必要がある~~ **改定**: システムは対応エンジンが存在しないアーキテクチャのモデルが要求された場合、エラーを返す必要がある
- **FR-006**: システムは登録形式とGPUバックエンドに基づき、必要アーティファクトのみを取得する必要がある
- **FR-007**: システムは同一モデルへの同時ダウンロード要求を検出し、重複ダウンロードを防止する必要がある
- **FR-008**: システムはダウンロード進捗を通知する必要がある（推奨: 10%単位）
- **FR-009**: ノードは同期状態（idle/running/success/failed）と進捗（モデル名・ファイル名・ダウンロード量）をロードバランサーへ通知する必要がある
- **FR-010**: ロードバランサーは最新の同期状態を保持し、APIおよびダッシュボードで可視化できる必要がある

### 自動認識要件（新規追加 2026-01-25）

- **FR-011**: システムはダウンロード完了後、`config.json`からアーキテクチャを自動検出する必要がある
- **FR-012**: 検出したアーキテクチャに対応エンジンが存在しない場合、WARNログを出力しモデルを利用不可としてマークする

### 主要エンティティ

- ~~**supported_models.json**: サポートされるモデルの定義ファイル。モデルID、外部ソースURL、形式、必要アーティファクトを含む~~ **廃止**
- **config.json**: HuggingFace形式のモデル設定ファイル。`architectures`フィールドからアーキテクチャを検出
- **モデルパス**: モデルファイル（GGUF/safetensors/Metal等）の場所を示す。ローカルまたは外部ソース経由で解決される
- **ロードバランサーAPI**: メタデータ/モデル一覧の提供に使用（バイナリ配信は必須ではない）
- **EngineRegistry**: アーキテクチャと対応エンジンのマッピングを管理

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- モデルファイルの破損検出・自動修復機能（auto_repair）
- モデルファイルのバージョン管理・ロールバック機能
- 共有ストレージ（NFS等）からの直接モデル参照（廃止）

---

## 技術制約 *(該当する場合)*

- ~~取得可能なモデルは`supported_models.json`に定義されたもののみに限定される~~ **廃止**: 任意のHuggingFaceモデルを取得可能
- ノードは外部ソース（HF等）にアクセス可能である必要がある
- 対応エンジンが存在するアーキテクチャのモデルのみ実行可能

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ~~`supported_models.json`が最新の状態で維持されている~~ **廃止**
- ノードから外部ソース（HF等）へのネットワーク接続が確立されている
- モデルリポジトリにHuggingFace形式の`config.json`が含まれている

---

## 依存関係 *(該当する場合)*

### 前提条件（このSPECが依存するもの）

- **SPEC-dcaeaec4**: LLM-Load Balancer独自モデルストレージ
- **SPEC-11106000**: Hugging Face URL登録
- ~~**SPEC-6cd7f960**: 対応モデルリスト型管理（`supported_models.json`）~~ **依存解除**: 自動認識への移行により不要
- マニフェスト取得（`/v0/models/registry/:model_name/manifest.json`）

### 依存元（このSPECに依存するもの）

- なし

---

## Clarifications

### Session 2025-12-30

インタビューにより以下が確定:

- **共有パス機能**: 廃止（本SPECのスコープから削除）
- **対象モデル**: `supported_models.json`に定義されたモデルのみ
- **目的再定義**: xLLMランタイム側での自動取得（共有パス参照は行わない）
- **解決優先順位**: ローカル → 外部ソース

**実装時の判断に委ねる事項**:

- 外部ソース/プロキシ経由ダウンロード時のタイムアウト値（推奨: 5分）
- ダウンロード進捗表示の粒度（推奨: 10%単位）
- 同時ダウンロード数の上限（推奨: 1件/ノード）

### Session 2025-12-31

- **対象は全モデル**（GGUF / safetensors / Metal 等）
- **Node が外部ソースから直接取得**し、ロードバランサーはバイナリを保持しない
- **変換パイプラインは廃止**（登録時の変換は行わない）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. ~~`supported_models.json`に定義されたモデルがローカルにない場合でも、外部ソースから直接取得され、推論リクエストが成功する~~ **改定**: 任意のHuggingFaceモデルがローカルにない場合でも、外部ソースから直接取得され、対応アーキテクチャであれば推論リクエストが成功する
2. ~~`supported_models.json`に未定義のモデルが要求された場合、1秒以内に明確なエラーメッセージが返る~~ **改定**: 対応エンジンが存在しないアーキテクチャのモデルが要求された場合、1秒以内に明確なエラーメッセージが返る
3. 同一モデルへの同時リクエストで重複ダウンロードが発生しない
4. ダウンロード進捗が10%単位で通知される
5. config.jsonからアーキテクチャが正しく検出される
