# 機能仕様書: safetensors量子化対応

**機能ID**: `SPEC-afa11b7d`
**作成日**: 2026-01-27
**ステータス**: 完了
**入力**: ユーザー説明: "safetensors量子化対応"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - safetensorsモデルを量子化して推論したい (優先度: P1)

開発者として、safetensors形式のモデルを量子化して推論を実行し、VRAM消費を抑えながら実用的な応答を得たい。

**この優先度の理由**: safetensorsモデルは最新モデルの主要フォーマットであり、量子化による実運用の可否が利用可否を左右する。

**独立テスト**: 既知のsafetensorsモデルに量子化設定を指定し、推論が成功し、未量子化時よりVRAM消費が低いことを確認する。

**受け入れシナリオ**:

1. **前提** safetensors形式のモデルと量子化設定が指定済み、**実行** 推論を実行、**結果** 推論が成功する
2. **前提** 同一モデルで量子化と非量子化を比較、**実行** 推論を実行、**結果** 量子化の方がVRAM消費が低い

---

### ユーザーストーリー2 - 量子化設定を指定・確認したい (優先度: P1)

運用者として、モデル取得または実行時に量子化設定を指定し、一覧や詳細で量子化状態を確認したい。

**この優先度の理由**: 量子化の有無や種類は運用判断に直結するため、指定と可視化が不可欠。

**独立テスト**: 量子化を指定してモデルを利用し、一覧や詳細に量子化情報が表示されることを確認する。

**受け入れシナリオ**:

1. **前提** 量子化設定を指定、**実行** モデルを取得または実行、**結果** 量子化情報が一覧/詳細に表示される

---

### ユーザーストーリー3 - 未対応の量子化は明確に失敗してほしい (優先度: P2)

開発者として、未対応の量子化方式を指定した場合に、明確で行動可能なエラーが返ってほしい。

**この優先度の理由**: サイレントなフォールバックは品質劣化や運用事故の原因となる。

**独立テスト**: 未対応の量子化方式を指定し、明確なエラーが返ることを確認する。

**受け入れシナリオ**:

1. **前提** 未対応の量子化方式を指定、**実行** モデルを取得または実行、**結果** 明確なエラーが返る

---

### エッジケース

- 量子化設定が空・不正形式の場合、どのように扱うか?
- GPUバックエンドが未対応の場合、どのように案内するか?
- 量子化に必要な追加アーティファクトが欠落している場合、どのように扱うか?
- 量子化とモデルアーキテクチャが不整合の場合、どのように扱うか?
- 量子化指定時のフォールバック方針はどうするか?（要明確化）

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはsafetensorsモデルに対して量子化設定を指定できる必要がある
- **FR-002**: システムは少なくとも1種類のsafetensors量子化方式をサポートする必要がある
- **FR-003**: システムは量子化設定をモデルの一覧・詳細で確認できる必要がある
- **FR-004**: システムは未対応の量子化方式指定を明確なエラーで拒否する必要がある
- **FR-005**: システムは量子化を指定しない場合、従来どおり非量子化のsafetensors推論を提供する必要がある
- **FR-006**: システムはGGUFの挙動を変更せず、safetensors量子化対応を追加する必要がある

*不明確な要件をマークする例:*

- **FR-007**: システムはsafetensors向け量子化として次の方式をサポートする必要がある
  - `kv_int8`（KVキャッシュINT8量子化）
  - `kv_fp8`（KVキャッシュFP8量子化）
  - ※ここでの量子化は重み量子化ではなくKVキャッシュ量子化を指す
- **FR-008**: システムは次の入口と優先順位で量子化を決定する必要がある
  1. モデル名サフィックス（`model:kv_int8` / `model:kv_fp8` / `model:Q4_K_M`）
  2. （GGUFのみ）manifestの`quantization`
  3. 量子化なし（従来どおり）
  - `kv_*`はsafetensors専用の予約トークンとして扱い、GGUF解決に流用しない
- **FR-009**: システムは量子化指定時のフォールバックを行わず、次の方針で明示的に失敗させる必要がある
  - 未対応方式: 明確な"unsupported quantization"系エラー
  - 不正指定: 明確な"invalid quantization"系エラー
  - safetensorsにGGUF量子化（例: `Q4_K_M`）を指定した場合も明示エラー

### 主要エンティティ *(機能がデータを含む場合に含める)*

- **QuantizationProfile**: 量子化方式の識別子と、適用対象（safetensorsモデル）に紐づく設定情報
- **ModelMetadata**: 量子化設定の有無・種類を含むモデルメタデータ

## 成功基準 *(必須)*

### 測定可能な結果

- **SC-001**: 参照モデルで量子化を指定した推論が成功し、同一モデルの非量子化よりVRAM使用量が低い
- **SC-002**: 量子化指定モデルが一覧/詳細に明示され、運用者が判別できる
- **SC-003**: 未対応の量子化方式を指定すると、明確なエラーメッセージが返る
