# 機能仕様書: CLI インターフェース整備

**機能ID**: `SPEC-a7e6d40a`
**作成日**: 2025-11-30
**更新日**: 2025-12-10
**ステータス**: ✅ 実装完了
**入力**: ユーザー説明: "CLIインターフェース整備 - ヘルプ、バージョンオプションのみ"

## 設計原則

**CLIはサーバー起動専用とし、すべての管理操作はAPI/Dashboard経由で行う。**

Load Balancer/Node共に、CLIは以下のオプションのみをサポート：

- `-h, --help`: ヘルプ表示
- `-V, --version`: バージョン表示

ユーザー管理・モデル管理などの操作は、REST API または Dashboard UI を通じて行う。

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - ロードバランサーの通常起動 (優先度: P1)

管理者として、引数なしでコマンドを実行するだけでロードバランサーサービスを起動できる。
設定は環境変数で事前に定義されており、起動コマンドは最小限で済む。

**この優先度の理由**: ロードバランサーの主要機能であり、最も頻繁に使用される操作。

**独立テスト**: `llmlb` を引数なしで実行し、サービスが正常に起動することで完全にテストできる。

**受け入れシナリオ**:

1. **前提** 環境変数`LLMLB_PORT`が設定されている、
   **実行** `llmlb`を引数なしで実行、
   **結果** 指定ポートでロードバランサーサービスが起動する
2. **前提** 環境変数が未設定、
   **実行** `llmlb`を引数なしで実行、
   **結果** デフォルト設定（ポート32768）でロードバランサーサービスが起動する

---

### ユーザーストーリー2 - ヘルプ表示 (優先度: P1)

管理者として、コマンドの使い方がわからないとき、ヘルプを表示して
利用可能なオプションと環境変数を確認できる。

**この優先度の理由**: ユーザビリティの基本。新規ユーザーが最初に必要とする機能。

**独立テスト**: `llmlb --help` を実行し、使い方が表示されることで完全にテストできる。

**受け入れシナリオ**:

1. **前提** ロードバランサーがインストールされている（Linux/Windows/macOS）、
   **実行** `llmlb --help`を実行、
   **結果** 利用可能なオプションと環境変数の説明が表示される
2. **前提** ロードバランサーがインストールされている、
   **実行** `llmlb -h`を実行、
   **結果** 短縮形でもヘルプが表示される

---

### ユーザーストーリー3 - バージョン表示 (優先度: P1)

管理者として、現在インストールされているロードバランサーのバージョンを確認できる。
トラブルシューティングや互換性確認に必要。

**この優先度の理由**: バージョン確認は問題報告や互換性確認の基本。

**独立テスト**: `llmlb --version` を実行し、バージョン番号が表示されることで完全にテストできる。

**受け入れシナリオ**:

1. **前提** ロードバランサーがインストールされている（Linux/Windows/macOS）、
   **実行** `llmlb --version`を実行、
   **結果** バージョン番号（例: `llmlb 2.1.0`）が表示される
2. **前提** ロードバランサーがインストールされている、
   **実行** `llmlb -V`を実行、
   **結果** 短縮形でもバージョンが表示される

---

### エッジケース

- 不正なオプションを指定した場合、エラーメッセージとヘルプへの誘導を表示
- サブコマンドを指定した場合、エラーメッセージを表示（サブコマンドは廃止済み）

## 要件

### 機能要件

- **FR-001**: 引数なしで実行した場合、ロードバランサーサービスを起動する
- **FR-002**: `--help`または`-h`オプションで使用方法を表示する
- **FR-003**: `--version`または`-V`オプションでバージョン情報を表示する
- **FR-004**: すべての設定は環境変数`LLMLB_*`で行い、CLIオプションでは設定を受け付けない
- **FR-005**: `-h`/`-V`オプションはすべてのプラットフォーム（Linux/Windows/macOS）で動作する

### 廃止された機能（後方互換なし）

以下の機能は廃止され、完全に削除されました：

- `user` サブコマンド（list/add/delete）- API経由 `/v0/users/*` を使用
- `model` サブコマンド（list/add/download）- API経由 `/v1/models/*` を使用
- `--preload-model` オプション - Dashboard経由でモデル配布を実行

### 環境変数（設定）

以下の環境変数で設定を行う（`LLMLB_*`プレフィックスで統一）:

| 環境変数 | 説明 | デフォルト値 |
|---------|------|------------|
| `LLMLB_PORT` | 待受ポート | 32768 |
| `LLMLB_HOST` | 待受アドレス | 0.0.0.0 |
| `LLMLB_LOG_LEVEL` | ログレベル | info |
| `LLMLB_JWT_SECRET` | JWT署名キー | ランダム生成 |
| `LLMLB_ADMIN_USERNAME` | 初期管理者ユーザー名 | admin |
| `LLMLB_ADMIN_PASSWORD` | 初期管理者パスワード | （必須・初回起動時のみ） |
| `LLMLB_OPENAI_API_KEY` | OpenAI APIキー | （オプション） |
| `LLMLB_ANTHROPIC_API_KEY` | Anthropic APIキー | （オプション） |
| `LLMLB_GOOGLE_API_KEY` | Google APIキー | （オプション） |

### 主要エンティティ

- **ユーザー**: ユーザー名、パスワードハッシュ、ロール（admin/user）を持つ認証エンティティ

---

## Node（C++）CLI要件

### ユーザーストーリー7 - ノードのヘルプ表示 (優先度: P1)

管理者として、ノードの使い方を確認できる。

**受け入れシナリオ**:

1. **前提** ノードがインストールされている、
   **実行** `xllm --help`を実行、
   **結果** 利用可能なオプションと環境変数の説明が表示される

---

### ユーザーストーリー8 - ノードのバージョン表示 (優先度: P1)

管理者として、ノードのバージョンを確認できる。

**受け入れシナリオ**:

1. **前提** ノードがインストールされている、
   **実行** `xllm --version`を実行、
   **結果** バージョン番号が表示される

---

### ユーザーストーリー9 - JWT_SECRETの自動生成と永続化 (優先度: P1)

管理者として、JWT_SECRETを手動で設定する必要がなく、
システムが安全に自動生成して永続化する。再起動後もトークンが有効なまま維持される。

**受け入れシナリオ**:

1. **前提** 初回起動（`~/.llmlb/jwt_secret`が存在しない）、
   **実行** `llmlb`を起動、
   **結果** UUIDv4でJWT_SECRETが自動生成され、ファイルに保存される
2. **前提** `~/.llmlb/jwt_secret`が存在する、
   **実行** `llmlb`を起動、
   **結果** 既存のJWT_SECRETがファイルから読み込まれる
3. **前提** 環境変数`LLMLB_JWT_SECRET`が設定されている、
   **実行** `llmlb`を起動、
   **結果** 環境変数の値が優先して使用される

---

### Node機能要件

- **FR-009**: `--help`または`-h`オプションで使用方法を表示する
- **FR-010**: `--version`または`-V`オプションでバージョン情報を表示する
- **FR-011**: 引数なしで実行した場合、ノードサービスを起動する
- **FR-012**: すべての設定は環境変数`XLLM_*`で行う

### Node環境変数（設定）

| 環境変数 | 説明 | デフォルト値 |
|---------|------|------------|
| `LLMLB_URL` | ロードバランサーURL | `http://127.0.0.1:32768` |
| `XLLM_PORT` | 待受ポート | 32769 |
| `XLLM_IP` | ノードIP | (自動検出) |
| `XLLM_MODELS_DIR` | モデル保存先 | `~/.runtime/models` |
| `XLLM_LOG_LEVEL` | ログレベル | info |
| `XLLM_LOG_DIR` | ログディレクトリ | `~/.llmlb/logs` |
| `XLLM_HEARTBEAT_SECS` | ハートビート間隔 | 10 |
| `XLLM_BIND_ADDRESS` | バインドアドレス | 0.0.0.0 |

### JWT_SECRET要件

- **FR-013**: JWT_SECRETを`~/.llmlb/jwt_secret`に永続化する
- **FR-014**: ファイルが存在しない場合、UUIDv4で自動生成する
- **FR-015**: ファイルのパーミッションは600（所有者のみ読み書き可能）
- **FR-016**: 環境変数`LLMLB_JWT_SECRET`が設定されていれば優先使用する

---

## スコープ外

以下の機能は本仕様のスコープ外とし、API/Dashboard経由で対応:

- インタラクティブモード（対話形式での設定）
- 設定ファイル（YAML/TOML）からの読み込み
- CLI経由のユーザー管理（API `/v0/users/*` で対応済み）
- CLI経由のモデル管理（API `/v1/models/*` で対応済み）

---

## 技術制約

- 設定はすべて環境変数経由で行う（CLIオプションで設定値を渡さない）
- ロードバランサー環境変数名は`LLMLB_*`プレフィックスで統一する
- ノード環境変数名は`XLLM_*`プレフィックスで統一する
- 既存の環境変数名（`LLMLB_PORT`、`LLM_MODELS_DIR`等）は非推奨とし、将来のバージョンで削除予定
- Node CLIはC++標準ライブラリのみ使用（外部CLI解析ライブラリ不要）

---

## 前提条件

この機能は以下を前提とします:

- ロードバランサーバイナリがインストールされている
- ノードバイナリがインストールされている
- データベースファイル（`~/.llmlb/lb.db`）への読み書き権限がある
- JWT_SECRETファイル（`~/.llmlb/jwt_secret`）への読み書き権限がある

---

## 成功基準

以下の成功基準を満たす必要があります:

1. 管理者は引数なしでロードバランサーを起動でき、従来通りサービスが動作する
2. 管理者は引数なしでノードを起動でき、従来通りサービスが動作する
3. 管理者は`llmlb --help`で30秒以内に必要な情報を見つけられる
4. 管理者は`xllm --help`で30秒以内に必要な情報を見つけられる
5. `-h`/`-V`オプションがすべてのプラットフォーム（Linux/Windows/macOS）で動作する
6. ロードバランサー環境変数が`LLMLB_*`プレフィックスで統一されている
7. ノード環境変数が`XLLM_*`プレフィックスで統一されている
8. JWT_SECRETが自動生成・永続化され、再起動後もトークンが有効

## 実装状態

✅ **実装済み** (2025-12-10)

- ヘルプ表示（`-h/--help`）
- バージョン表示（`-V/--version`）
- 引数なしでサーバー起動
- 全プラットフォーム対応（Linux CLI、Windows/macOS GUI トレイ）
- 廃止コマンド（user/model）の完全削除

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。実装も完了しています。

**確認済み事項**:

- CLIオプション: -h/--help, -V/--version のみ（FR-002, FR-003で明記）
- 設定方式: 環境変数のみ、CLIオプションで設定値は受け付けない（FR-004で明記）
- 環境変数プレフィックス: Load Balancer=LLMLB_*, xLLM=XLLM_*
- JWT_SECRET: 自動生成・永続化（~/.llmlb/jwt_secret）（FR-013~FR-016で明記）

**廃止された機能**:

- userサブコマンド → API /v0/users/*
- modelサブコマンド → API /v1/models/*
- --preload-modelオプション → Dashboard経由
