# 機能仕様書: CLI インターフェース整備

**機能ID**: `SPEC-a7e6d40a`
**作成日**: 2025-11-30
**ステータス**: 下書き
**入力**: ユーザー説明: "CLIインターフェース整備 - ヘルプ、バージョン、ユーザー管理コマンド"

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - ルーターの通常起動 (優先度: P1)

管理者として、引数なしでコマンドを実行するだけでルーターサービスを起動できる。
設定は環境変数で事前に定義されており、起動コマンドは最小限で済む。

**この優先度の理由**: ルーターの主要機能であり、最も頻繁に使用される操作。

**独立テスト**: `llm-router` を引数なしで実行し、サービスが正常に起動することで完全にテストできる。

**受け入れシナリオ**:

1. **前提** 環境変数`LLM_ROUTER_PORT`が設定されている、
   **実行** `llm-router`を引数なしで実行、
   **結果** 指定ポートでルーターサービスが起動する
2. **前提** 環境変数が未設定、
   **実行** `llm-router`を引数なしで実行、
   **結果** デフォルト設定（ポート8080）でルーターサービスが起動する

---

### ユーザーストーリー2 - ヘルプ表示 (優先度: P1)

管理者として、コマンドの使い方がわからないとき、ヘルプを表示して
利用可能なコマンドとオプションを確認できる。

**この優先度の理由**: ユーザビリティの基本。新規ユーザーが最初に必要とする機能。

**独立テスト**: `llm-router --help` を実行し、使い方が表示されることで完全にテストできる。

**受け入れシナリオ**:

1. **前提** ルーターがインストールされている、
   **実行** `llm-router --help`を実行、
   **結果** 利用可能なサブコマンドと環境変数の説明が表示される
2. **前提** ルーターがインストールされている、
   **実行** `llm-router user --help`を実行、
   **結果** ユーザー管理サブコマンドの詳細な使い方が表示される

---

### ユーザーストーリー3 - バージョン表示 (優先度: P1)

管理者として、現在インストールされているルーターのバージョンを確認できる。
トラブルシューティングや互換性確認に必要。

**この優先度の理由**: バージョン確認は問題報告や互換性確認の基本。

**独立テスト**: `llm-router --version` を実行し、バージョン番号が表示されることで完全にテストできる。

**受け入れシナリオ**:

1. **前提** ルーターがインストールされている、
   **実行** `llm-router --version`を実行、
   **結果** バージョン番号（例: `llm-router 0.1.0`）が表示される

---

### ユーザーストーリー4 - ユーザー一覧表示 (優先度: P2)

管理者として、システムに登録されているユーザーの一覧を確認できる。
ユーザー管理の状況把握に必要。

**この優先度の理由**: ユーザー管理の前提となる基本的な確認機能。

**独立テスト**: `llm-router user list` を実行し、ユーザー一覧が表示されることで完全にテストできる。

**受け入れシナリオ**:

1. **前提** ユーザーが1人以上登録されている、
   **実行** `llm-router user list`を実行、
   **結果** ユーザー名とロールの一覧が表示される
2. **前提** ユーザーが登録されていない、
   **実行** `llm-router user list`を実行、
   **結果** 「登録ユーザーなし」のメッセージが表示される

---

### ユーザーストーリー5 - ユーザー登録 (優先度: P2)

管理者として、新しいユーザーをシステムに登録できる。
Web UIからの登録に加えて、CLIからの一括登録やスクリプト化が可能になる。

**この優先度の理由**: ユーザー管理の基本操作。自動化・スクリプト化に必要。

**独立テスト**: `llm-router user add` を実行し、ユーザーが作成されることで完全にテストできる。

**受け入れシナリオ**:

1. **前提** 「testuser」というユーザーが存在しない、
   **実行** `llm-router user add testuser --password secret123`を実行、
   **結果** ユーザー「testuser」が作成され、成功メッセージが表示される
2. **前提** 「admin」というユーザーが既に存在する、
   **実行** `llm-router user add admin --password newpass`を実行、
   **結果** エラーメッセージ「ユーザーは既に存在します」が表示される

---

### ユーザーストーリー6 - ユーザー削除 (優先度: P2)

管理者として、不要になったユーザーをシステムから削除できる。

**この優先度の理由**: ユーザー管理の基本操作。

**独立テスト**: `llm-router user delete` を実行し、ユーザーが削除されることで完全にテストできる。

**受け入れシナリオ**:

1. **前提** 「testuser」というユーザーが存在する、
   **実行** `llm-router user delete testuser`を実行、
   **結果** ユーザー「testuser」が削除され、成功メッセージが表示される
2. **前提** 「unknown」というユーザーが存在しない、
   **実行** `llm-router user delete unknown`を実行、
   **結果** エラーメッセージ「ユーザーが見つかりません」が表示される

---

### エッジケース

- 不正なサブコマンドを指定した場合、エラーメッセージとヘルプへの誘導を表示
- データベースファイルが存在しない状態でユーザー操作を行った場合、適切なエラーメッセージを表示
- パスワードが短すぎる場合（8文字未満）、バリデーションエラーを表示

## 要件

### 機能要件

- **FR-001**: 引数なしで実行した場合、ルーターサービスを起動する
- **FR-002**: `--help`または`-h`オプションで使用方法を表示する
- **FR-003**: `--version`または`-V`オプションでバージョン情報を表示する
- **FR-004**: `user list`サブコマンドで登録ユーザー一覧を表示する
- **FR-005**: `user add <username> --password <password>`で新規ユーザーを登録する
- **FR-006**: `user delete <username>`で既存ユーザーを削除する
- **FR-007**: すべての設定は環境変数`LLM_ROUTER_*`で行い、CLIオプションでは設定を受け付けない
- **FR-008**: パスワードは8文字以上を必須とする

### 環境変数（設定）

以下の環境変数で設定を行う（`LLM_ROUTER_*`プレフィックスで統一）:

| 環境変数 | 説明 | デフォルト値 |
|---------|------|------------|
| `LLM_ROUTER_PORT` | 待受ポート | 8080 |
| `LLM_ROUTER_HOST` | 待受アドレス | 0.0.0.0 |
| `LLM_ROUTER_LOG_LEVEL` | ログレベル | info |
| `LLM_ROUTER_JWT_SECRET` | JWT署名キー | ランダム生成 |
| `LLM_ROUTER_ADMIN_USERNAME` | 初期管理者ユーザー名 | admin |
| `LLM_ROUTER_ADMIN_PASSWORD` | 初期管理者パスワード | （必須・初回起動時のみ） |
| `LLM_ROUTER_OPENAI_API_KEY` | OpenAI APIキー | （オプション） |
| `LLM_ROUTER_ANTHROPIC_API_KEY` | Anthropic APIキー | （オプション） |
| `LLM_ROUTER_GOOGLE_API_KEY` | Google APIキー | （オプション） |

### 主要エンティティ

- **ユーザー**: ユーザー名、パスワードハッシュ、ロール（admin/user）を持つ認証エンティティ

---

## Node（C++）CLI要件

### ユーザーストーリー7 - ノードのヘルプ表示 (優先度: P1)

管理者として、ノードの使い方を確認できる。

**受け入れシナリオ**:

1. **前提** ノードがインストールされている、
   **実行** `llm-node --help`を実行、
   **結果** 利用可能なオプションと環境変数の説明が表示される

---

### ユーザーストーリー8 - ノードのバージョン表示 (優先度: P1)

管理者として、ノードのバージョンを確認できる。

**受け入れシナリオ**:

1. **前提** ノードがインストールされている、
   **実行** `llm-node --version`を実行、
   **結果** バージョン番号が表示される

---

### ユーザーストーリー9 - JWT_SECRETの自動生成と永続化 (優先度: P1)

管理者として、JWT_SECRETを手動で設定する必要がなく、
システムが安全に自動生成して永続化する。再起動後もトークンが有効なまま維持される。

**受け入れシナリオ**:

1. **前提** 初回起動（`~/.llm-router/jwt_secret`が存在しない）、
   **実行** `llm-router`を起動、
   **結果** UUIDv4でJWT_SECRETが自動生成され、ファイルに保存される
2. **前提** `~/.llm-router/jwt_secret`が存在する、
   **実行** `llm-router`を起動、
   **結果** 既存のJWT_SECRETがファイルから読み込まれる
3. **前提** 環境変数`LLM_ROUTER_JWT_SECRET`が設定されている、
   **実行** `llm-router`を起動、
   **結果** 環境変数の値が優先して使用される

---

### Node機能要件

- **FR-009**: `--help`または`-h`オプションで使用方法を表示する
- **FR-010**: `--version`または`-V`オプションでバージョン情報を表示する
- **FR-011**: 引数なしで実行した場合、ノードサービスを起動する
- **FR-012**: すべての設定は環境変数`LLM_NODE_*`で行う

### Node環境変数（設定）

| 環境変数 | 説明 | デフォルト値 |
|---------|------|------------|
| `LLM_ROUTER_URL` | ルーターURL | `http://127.0.0.1:8080` |
| `LLM_NODE_PORT` | 待受ポート | 11435 |
| `LLM_NODE_IP` | ノードIP | (自動検出) |
| `LLM_NODE_MODELS_DIR` | モデル保存先 | `~/.runtime/models` |
| `LLM_NODE_LOG_LEVEL` | ログレベル | info |
| `LLM_NODE_LOG_DIR` | ログディレクトリ | `~/.llm-node/logs` |
| `LLM_NODE_HEARTBEAT_SECS` | ハートビート間隔 | 10 |
| `LLM_NODE_ALLOW_NO_GPU` | GPU必須を緩和 | false |
| `LLM_NODE_BIND_ADDRESS` | バインドアドレス | 0.0.0.0 |

### JWT_SECRET要件

- **FR-013**: JWT_SECRETを`~/.llm-router/jwt_secret`に永続化する
- **FR-014**: ファイルが存在しない場合、UUIDv4で自動生成する
- **FR-015**: ファイルのパーミッションは600（所有者のみ読み書き可能）
- **FR-016**: 環境変数`LLM_ROUTER_JWT_SECRET`が設定されていれば優先使用する

---

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- インタラクティブモード（対話形式での設定）
- 設定ファイル（YAML/TOML）からの読み込み
- ユーザーのロール変更コマンド
- パスワード変更コマンド

---

## 技術制約

- 設定はすべて環境変数経由で行う（CLIオプションで設定値を渡さない）
- ルーター環境変数名は`LLM_ROUTER_*`プレフィックスで統一する
- ノード環境変数名は`LLM_NODE_*`プレフィックスで統一する
- 既存の環境変数名（`ROUTER_PORT`、`LLM_MODELS_DIR`等）は非推奨とし、将来のバージョンで削除予定
- Node CLIはC++標準ライブラリのみ使用（外部CLI解析ライブラリ不要）

---

## 前提条件

この機能は以下を前提とします:

- ルーターバイナリがインストールされている
- ノードバイナリがインストールされている
- データベースファイル（`~/.llm-router/router.db`）への読み書き権限がある
- JWT_SECRETファイル（`~/.llm-router/jwt_secret`）への読み書き権限がある

---

## 成功基準

以下の成功基準を満たす必要があります:

1. 管理者は引数なしでルーターを起動でき、従来通りサービスが動作する
2. 管理者は引数なしでノードを起動でき、従来通りサービスが動作する
3. 管理者は`llm-router --help`で30秒以内に必要な情報を見つけられる
4. 管理者は`llm-node --help`で30秒以内に必要な情報を見つけられる
5. 管理者はCLIから30秒以内に新規ユーザーを登録できる
6. ルーター環境変数が`LLM_ROUTER_*`プレフィックスで統一されている
7. ノード環境変数が`LLM_NODE_*`プレフィックスで統一されている
8. JWT_SECRETが自動生成・永続化され、再起動後もトークンが有効
