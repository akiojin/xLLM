# Test Workflow
# æ©Ÿèƒ½ID: SPEC-47c6f44c (quality-checks.ymlã‹ã‚‰åˆ†é›¢)
# ç›®çš„: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚¿ã‚¹ã‚¯å®Œäº†ãƒã‚§ãƒƒã‚¯
# è¦ä»¶: FR-002 (tasks.md check), FR-003 (Rust tests), OpenAI API tests

name: Test

on:
  pull_request:
    branches:
      - develop

jobs:
  # ãƒ‘ã‚¹å¤‰æ›´æ¤œå‡ºï¼ˆC++/Rustã‚¸ãƒ§ãƒ–ã®æ¡ä»¶ä»˜ãå®Ÿè¡Œç”¨ï¼‰
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      cpp: ${{ steps.filter.outputs.cpp }}
      rust: ${{ steps.filter.outputs.rust }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cpp:
              - 'node/**'
              - 'package.json'
              - '.github/actions/setup-cpp/**'
              - '.github/workflows/test.yml'
            rust:
              - 'router/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - '.github/workflows/test.yml'

  tasks-check:
    # è¦ä»¶: FR-002
    # ç›®çš„: tasks.mdã®å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’ãƒã‚§ãƒƒã‚¯
    name: Tasks Completion Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check tasks.md completion
        run: |
          echo "ğŸ” Checking tasks.md completion..."
          chmod +x .specify/scripts/checks/check-tasks.sh
          .specify/scripts/checks/check-tasks.sh
        env:
          CI: true

  rust-test:
    # è¦ä»¶: FR-003
    # ç›®çš„: Rustãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆè¤‡æ•°OSï¼‰
    name: Rust Tests (${{ matrix.os }})
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml
        shell: bash

      - name: Run Rust tests
        run: |
          echo "ğŸ§ª Running Rust tests on ${{ matrix.os }}..."
          cargo test --all-features --workspace -- --test-threads=1

  openai-proxy-tests:
    # è¦ä»¶: OpenAIäº’æ›APIã®å›å¸°ãƒ†ã‚¹ãƒˆ
    # ç›®çš„: OpenAI APIã¨ã®äº’æ›æ€§ã‚’ç¢ºèª
    name: OpenAI API Compatibility Tests
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml

      - name: Run OpenAI proxy tests
        run: |
          echo "ğŸ¤– Running OpenAI-compatible API tests..."
          make openai-tests

  cpp-tests:
    # C++ãƒãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ
    name: C++ Tests (Ubuntu)
    needs: changes
    if: needs.changes.outputs.cpp == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup C++ build environment
        uses: ./.github/actions/setup-cpp

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-test-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-test-

      - name: Configure C++ project
        run: cmake -S node -B node/build -DBUILD_TESTS=ON -DPORTABLE_BUILD=ON

      - name: Build C++ project
        run: cmake --build node/build --config Release

      - name: Show ccache stats
        run: ccache -s

      - name: Run C++ tests
        run: ctest --output-on-failure
        working-directory: node/build
