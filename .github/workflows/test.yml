# Test Workflow
# Ê©üËÉΩID: SPEC-47c6f44c (quality-checks.yml„Åã„ÇâÂàÜÈõ¢)
# ÁõÆÁöÑ: „ÉÜ„Çπ„ÉàÂÆüË°å„Å®„Çø„Çπ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
# Ë¶Å‰ª∂: FR-002 (tasks.md check), FR-003 (Rust tests), OpenAI API tests

name: Test

on:
  workflow_dispatch:
  pull_request:
    branches:
      - develop

jobs:
  # „Éë„ÇπÂ§âÊõ¥Ê§úÂá∫ÔºàC++/Rust„Ç∏„Éß„Éñ„ÅÆÊù°‰ª∂‰ªò„ÅçÂÆüË°åÁî®Ôºâ
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      cpp: ${{ steps.filter.outputs.cpp }}
      rust: ${{ steps.filter.outputs.rust }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cpp:
              - 'xllm/**'
              - 'package.json'
              - '.github/actions/setup-cpp/**'
              - '.github/workflows/test.yml'
            rust:
              - 'llmlb/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - '.github/workflows/test.yml'
            e2e:
              - 'llmlb/tests/e2e-playwright/**'
              - 'llmlb/src/dashboard/**'
              - '.github/workflows/test.yml'

  tasks-check:
    # Ë¶Å‰ª∂: FR-002
    # ÁõÆÁöÑ: tasks.md„ÅÆÂÖ®„Çø„Çπ„ÇØÂÆå‰∫Ü„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    name: Tasks Completion Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check tasks.md completion
        run: |
          echo "üîç Checking tasks.md completion..."
          chmod +x .specify/scripts/checks/check-tasks.sh
          .specify/scripts/checks/check-tasks.sh
        env:
          CI: true

  rust-test:
    # Ë¶Å‰ª∂: FR-003
    # ÁõÆÁöÑ: Rust„ÉÜ„Çπ„Éà„ÇíÂÆüË°åÔºàË§áÊï∞OSÔºâ
    name: Rust Tests (${{ matrix.os }})
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml
        shell: bash

      - name: Run Rust tests
        run: |
          echo "üß™ Running Rust tests on ${{ matrix.os }}..."
          cargo test --all-features --workspace -- --test-threads=1

  openai-proxy-tests:
    # Ë¶Å‰ª∂: OpenAI‰∫íÊèõAPI„ÅÆÂõûÂ∏∞„ÉÜ„Çπ„Éà
    # ÁõÆÁöÑ: OpenAI API„Å®„ÅÆ‰∫íÊèõÊÄß„ÇíÁ¢∫Ë™ç
    name: OpenAI API Compatibility Tests
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml

      - name: Run OpenAI proxy tests
        run: |
          echo "ü§ñ Running OpenAI-compatible API tests..."
          make openai-tests

  playwright-e2e:
    # Ë¶Å‰ª∂: E2E„ÉÜ„Çπ„ÉàÔºà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÉªPlaygroundÔºâ
    # ÁõÆÁöÑ: Playwright „Å´„Çà„Çã„Éñ„É©„Ç¶„Ç∂E2E„ÉÜ„Çπ„Éà
    name: Playwright E2E Tests
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml

      - name: Build llmlb
        run: cargo build --release -p llmlb

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install Playwright dependencies
        working-directory: llmlb/tests/e2e-playwright
        run: |
          pnpm install
          pnpm exec playwright install --with-deps chromium

      - name: Start llmlb server
        run: |
          mkdir -p llmlb/tests/e2e-playwright/.llmlb/logs
          LLMLB_DATABASE_URL=sqlite:llmlb/tests/e2e-playwright/.llmlb/router.db \
          LLMLB_LOG_DIR=llmlb/tests/e2e-playwright/.llmlb/logs \
          ./target/release/llmlb &
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://127.0.0.1:32768/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done

      - name: Run Playwright tests
        working-directory: llmlb/tests/e2e-playwright
        run: pnpm exec playwright test --reporter=list
        env:
          SKIP_SERVER: '1'
          BASE_URL: 'http://127.0.0.1:32768'
          CI: 'true'

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: llmlb/tests/e2e-playwright/reports/
          retention-days: 7

  cpp-tests:
    # C++„Éé„Éº„Éâ„ÅÆ„Éì„É´„Éâ„Å®„ÉÜ„Çπ„Éà
    name: C++ Tests (Ubuntu)
    needs: changes
    if: needs.changes.outputs.cpp == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup C++ build environment
        uses: ./.github/actions/setup-cpp

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-test-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-test-

      - name: Configure C++ project
        run: cmake -S xllm -B xllm/build -DBUILD_TESTS=ON -DPORTABLE_BUILD=ON

      - name: Build C++ project
        run: cmake --build xllm/build --config Release

      - name: Show ccache stats
        run: ccache -s

      - name: Run C++ tests
        run: ctest --output-on-failure --timeout 300 --verbose
        working-directory: xllm/build
