#!/usr/bin/env sh
set -e

if [ "${HUSKY:-}" = "0" ]; then
  echo "HUSKY=0 is not allowed in this repo." >&2
  exit 1
fi

BASE_REF=""
if git rev-parse --verify -q origin/feature/download-progress >/dev/null; then
  BASE_REF="origin/feature/download-progress"
elif git rev-parse --verify -q origin/develop >/dev/null; then
  BASE_REF="origin/develop"
elif git rev-parse --verify -q origin/main >/dev/null; then
  BASE_REF="origin/main"
fi

if [ -z "$BASE_REF" ]; then
  echo "⚠️  Could not determine base ref for linting; skipping pre-push checks."
  exit 0
fi

# Match CI: lint all Markdown and check commit messages in range.
if command -v pnpm >/dev/null 2>&1; then
  pnpm dlx markdownlint-cli2@0.13.0 "**/*.md" "!node_modules" "!.git" "!.github" "!.worktrees" "!third_party" "!build"
elif command -v npx >/dev/null 2>&1; then
  npx -y markdownlint-cli2@0.13.0 "**/*.md" "!node_modules" "!.git" "!.github" "!.worktrees" "!third_party" "!build"
else
  echo "Error: pnpm or npx not found. Please install Node.js and pnpm/npm." >&2
  exit 1
fi

bash .specify/scripts/checks/check-commits.sh --from "$BASE_REF" --to HEAD

if command -v cmake >/dev/null 2>&1; then
  cmake -S . -B build -DBUILD_TESTS=ON -DPORTABLE_BUILD=ON
  cmake --build build --config Release
  if command -v ctest >/dev/null 2>&1; then
    ctest --output-on-failure --timeout 300 --verbose
  else
    echo "Error: ctest not found. Please install CMake." >&2
    exit 1
  fi
else
  echo "Error: cmake not found. Please install CMake." >&2
  exit 1
fi
